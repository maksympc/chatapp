<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Authentication</title>
</head>

<body>
<h1>JWT</h1>
<div>
    <button id="test">Socket Auth</button>
    <button id="goodLogin">Login. Get token</button>
    <button id="badLogin">Bad Login</button>
    <button id="logout">Logout</button>
    <br/>
    <button id="ban_user">ban</button>
    <button id="unban_user">unban</button>
    <button id="mute_user">mute</button>
    <button id="unmute_user">unmute</button>
    <button id="new_message">new message</button>
    <button id="get_all_users">get all users</button>
    <button id="remove_all_messages">remove all messages</button>
</div>

<div><textarea id="token" cols="40" rows="10"></textarea></div>

<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        let socket;

        $('#test').click(function () {
            socket = io.connect('http://localhost:3000');
            socket.on('connect', function () {
                socket.emit('authenticate', {token: localStorage.token}).on('authenticated', function (message) {


                    $('#ban_user').click(function () {
                        socket.emit('ban user', 'maks@mail.com');
                    });

                    $('#unban_user').click(function () {
                        socket.emit('unban user', 'maks@mail.com');
                    });

                    $('#mute_user').click(function () {
                        socket.emit('mute user', 'maks@mail.com');
                    });
                    $('#unmute_user').click(function () {
                        socket.emit('unmute user', 'maks@mail.com');
                    });
                    $('#get_all_users').click(function () {
                        socket.emit('get all users');
                    });
                    $('#new_message').click(function () {
                        socket.emit('new message', {
                            email: 'maks@mail.com',
                            username: 'maks',
                            message: 'super secret test message!!!'
                        });
                    });
                    $('#remove_all_messages').click(function () {
                        socket.emit('remove all messages');
                    });

                    //describe on events
                    socket.on('login', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + data;
                    });
                    socket.on('user joined', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + data;
                    });
                    socket.on('info', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + data;
                    });
                    socket.on('new message', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('banned', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('unbanned', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('mute user', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('muted', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('unmute user', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('unmuted', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('get all users', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('remove all messages', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + '\n' + data;
                    });
                    socket.on('get all messages', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = infoBlock.innerText + data;
                    });
                    socket.on('user left', data => {
                        console.log(JSON.stringify(data));
                        let infoBlock = $('#info');
                        infoBlock.innerText = data;
                    });
                    socket.on('disconnect', () => {
                        alert('You were disconnected!');
                        localStorage.token = null;
                        window.location.replace("http://localhost:3000/");
                    });
                    socket.on('second connection', (data) => {
                        alert('Message:' + data.message);
                        localStorage.token = null;
                        window.location.replace("http://localhost:3000/");
                    });
                })
                    .on('unauthorized', function (message) {
                        console.log("unauthorized: " + JSON.stringify(message));
                        alert('Your token has been expired! Please login again!');
                        localStorage.token = null;
                        window.location.replace("http://localhost:3000/");
                    })
            });
        });


        $('#goodLogin').click(function () {
            $.ajax({
                type: "POST",
                url: "/api/login",
                data: {
                    email: "admin@admin.com",
                    username: "admin",
                    password: "adminadmin"
                },
                success: function (data) {
                    localStorage.token = data.token;
                    document.getElementById("token").innerText = localStorage.token;
                },
                error: function () {
                    alert("Login Failed");
                }
            });
        });
        $('#badLogin').click(function () {
            $.ajax({
                type: "POST",
                url: "/api/login",
                data: {
                    email: "admin@admin.com",
                    username: "john.doe",
                    password: "foobarfoobar"
                },
                success: function (data) {
                    alert("ERROR: it is not supposed to alert.");
                },
                error: function () {
                    document.getElementById("token").innerText = '';
                    alert("Login Failed");
                }
            });
        });
        $('#logout').click(function () {
            localStorage.clear();
            document.getElementById("token").innerText = '';
            socket.disconnect(true);
        });
    });
</script>
</body>

</html>